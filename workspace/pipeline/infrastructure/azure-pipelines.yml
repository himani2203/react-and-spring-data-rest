trigger:
- none

pool:
  #name: pool_name  #make sure this pool have access to backend storage where we have tfstate file
  vmImage: 'ubuntu-latest'

resources:
  repositories:
    - repository: repo-name
      type: git
      name: repo-name
    
parameters:
  - name: environment
    type: object
    default:
      - env: development
      - env: uat
      - env: production

stages:
  - ${{ each environment in parameters.environment }}:
    - ${{ if eq(environment.env, 'development') }}:
      - template: workspace/pipeline/infrastructure/build.yaml@repo-name
      
        parameters:
          environment: ${{ environment.env }}
          workingDirectory: workspace/environment/${{ environment.env }}
          backendServiceArm: 'Service_Connection_${{ environment.env }}'
          backendResourceGroupName: 'StorageAccount-ResourceGroup'
          backendStorageAccountName: 'storageaccountname'
          backendKey: '<key-name>.tfstate'
                
    - ${{ if eq(environment.env, 'uat') }}:
      - template: workspace/pipeline/infrastructure/build.yaml@repo-name
        parameters:
          environment: ${{ environment.env }}
          workingDirectory: workspace/environment/${{ environment.env }}
          backendServiceArm: 'Service_Connection_${{ environment.env }}'
          backendResourceGroupName: 'StorageAccount-ResourceGroup'
          backendStorageAccountName: 'storageaccountname'
          backendKey: '<key-name>.tfstate'

    - ${{ if eq(environment.env, 'production') }}:
      - template: workspace/pipeline/infrastructure/build.yaml@repo-name
        parameters:
          environment: ${{ environment.env }}
          workingDirectory: workspace/environment/${{ environment.env }}
          backendServiceArm: 'Service_Connection_${{ environment.env }}'
          backendResourceGroupName: 'StorageAccount-ResourceGroup'
          backendStorageAccountName: 'storageaccountname'
          backendKey: '<key-name>.tfstate'